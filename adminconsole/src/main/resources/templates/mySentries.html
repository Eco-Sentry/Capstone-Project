<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/mySentries.css">
    <title>Responsive Layout</title>
</head>
<body>
    <div class="navbar">
        <div class="logo">Logo</div>
        <nav class="nav-links">
            <a th:href="@{home}">Home</a>
            <a th:href="@{about}">About</a>
            <a th:href="@{profile}">Profile</a>
            <a th:href="@{dashboard}">Dashboard</a>
            <a th:href="@{mySentries}">My Sentries</a>
            <!-- <a href="#home">Home</a>
            <a href="#about">About</a>
            <a href="#profile">Profile</a>
            <a href="#dashboard">Dashboard</a>
            <a href="#mySentries">My Sentries</a> -->
        </nav>
    </div>
    <button class="sidebar-toggle" onclick="toggleSidebar()">â‡’</button>
    <div class="sidebar" id="sidebar">
        <a th:href="@{mySentries}">My sentries</a><br/>
        <a th:href="@{createSentry}">Create a Sentry</a>
    </div>
    <div class="content">
        <div class="main-div">
            <!-- Main here -->
            <h1>My Sentries</h1>
            <!-- <div class="popup" >
                <span class="popuptext" id="myPopup">Popup text...</span>
            </div> -->

            <table>
                <thead>
                    <tr>
                        <th>S/N</th>
                        <th>Name</th>
                        <th>Location</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sentriesBody">
                    
                </tbody>
            </table>
        </div>
    </div>
    
    

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener("DOMContentLoaded", function() {
            fetchSentries();
        });

        function fetchSentries() {
            const token = getCookie('AUTH-TOKEN');
            if (!token) {
                console.error('No AUTH-TOKEN found');
                return; // Exit if no token
            }
            const url = 'http://202.65.64.38:8082/api/get-user-sentries';
            // const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuaWNrLnRvb2xlQGdtYWlsLmNvbSIsImlhdCI6MTcxNTA3NTQzNiwiZXhwIjoxNzE1MTExNDM2fQ.CtuPpFcDXwUvPNp7ro-D4BfM5AW3CR4rY8IDdV1VcBc";


            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: token
            })
            .then(response => response.json())
            .then(data => {
                populateTable(data);
            })
            .catch(error => console.error('Error fetching sentries:', error));
        }

        function populateTable(sentries) {
            const tableBody = document.getElementById('sentriesBody');
            tableBody.innerHTML = '';

            sentries.forEach((sentry, index) => {
                const row = `<tr>
                                <td>${index + 1}</td>
                                <td>Sentry ${index + 1}</td>
                                <td>${sentry.latitude}, ${sentry.longitude}</td>
                                <td>
                                    <button onclick="viewSentry('${sentry.id}')">View</button>
                                    <div class="popup">
                                        <p class="popuptext" id="myPopup">
                                            Are you sure you want to delete this sentry?
                                            <button onclick="confirmDeleteSentry('${sentry.id}')">Yes</button>
                                            <button onclick="myFunction()">No</button>
                                        </p>
                                        <button onclick="myFunction()" onclick="confirmDeleteSentry('${sentry.id}')">Delete</button>
                                    </div>
                                </td>
                            </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function viewSentry(id) {
            window.location.href = `sentryInfo?id=${id}`;
        }

        function confirmDeleteSentry(id) {
            // if (confirm('Are you sure you want to delete this sentry?')) {
            //     deleteSentry(id);
            // }
            deleteSentry(id);
        }

        function deleteSentry(id) {
            const token = getCookie('AUTH-TOKEN');
            if (!token) {
                console.error('No AUTH-TOKEN found');
                return; // Exit if no token
            }

            // const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuaWNrLnRvb2xlQGdtYWlsLmNvbSIsImlhdCI6MTcxNTA3NTQzNiwiZXhwIjoxNzE1MTExNDM2fQ.CtuPpFcDXwUvPNp7ro-D4BfM5AW3CR4rY8IDdV1VcBc";
            fetch('http://202.65.64.38:8082/api/delete-sentry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token: token, objId: id })
            })
            .then(response => {
                if (response.ok) {
                    // alert('Sentry deleted successfully!');
                    console.log('Sentry deleted successfully: ', id);
                    fetchSentries(); // Refresh the list 
                } else {
                    alert('Failed to delete sentry.');
                }
            })
            .catch(error => {
                console.error('Error deleting sentry:', error);
                alert('Failed to delete sentry. Please try again.');
            });
        }

        // When the user clicks on <div>, open the popup
        function myFunction() {
        var popup = document.getElementById("myPopup");
        popup.classList.toggle("show");
        }
    </script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.style.transform === 'translateX(0px)') {
                sidebar.style.transform = 'translateX(-100%)'; // Hide the sidebar
            } else {
                sidebar.style.transform = 'translateX(0px)'; // Show the sidebar
            }
        }
        // Add event listener to handle window resizing
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth >= 768) {
                // Ensure sidebar is open on larger screens
                sidebar.style.transform = 'translateX(0px)';
            } else if (window.innerWidth < 768 && sidebar.style.transform === 'translateX(0px)') {
                // Keep current state if the sidebar is already open
                sidebar.style.transform = 'translateX(-100%)';
                return;
            } else {
                // Ensure sidebar is closed on smaller screens when not specifically toggled
                sidebar.style.transform = 'translateX(-100%)';
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const navbar = document.querySelector('.navbar');

            navbar.addEventListener('click', function(event) {
                if (window.innerWidth < 768) {
                    navbar.classList.toggle('active');
                    if (navbar.classList.contains('active')) {
                        navbar.style.height = '100vh'; // Full height
                    } else {
                        navbar.style.height = '60px'; // Default height
                    }
                }
            });

            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768) {
                    navbar.classList.remove('active');
                    navbar.style.height = '60px'; // Ensure default height
                }
            });

            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth >= 768) {
                // Ensure sidebar is open on larger screens
                sidebar.style.transform = 'translateX(0px)';
            } else if (window.innerWidth < 768 && sidebar.style.transform === 'translateX(0px)') {
                // Keep current state if the sidebar is already open
                return;
            } else {
                // Ensure sidebar is closed on smaller screens when not specifically toggled
                sidebar.style.transform = 'translateX(-100%)';
            }
        });

    </script>
</body>
</html>